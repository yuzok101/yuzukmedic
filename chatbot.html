<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>爪'   - 拽专住</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: Arial, sans-serif;
      direction: rtl;
      background: transparent;
      overflow: hidden;
    }
    #chat-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: #007bff;
      color: white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      text-align: center;
      line-height: 60px;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 0 15px rgba(0,123,255,0.7);
      user-select: none;
    }
    #chatbot-box {
      position: fixed;
      bottom: 90px;
      left: 20px;
      width: 360px;
      height: 480px;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
      border: 1px solid #007bff;
    }
    #chat-header {
      background-color: #007bff;
      color: white;
      padding: 12px;
      font-weight: bold;
      text-align: center;
      user-select: none;
    }
    #chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f0f4ff;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.4em;
    }
    #chat-input-box {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      gap: 5px;
    }
    #chat-input {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
      outline: none;
    }
    #chat-input:focus {
      border-color: #007bff;
      box-shadow: 0 0 5px #007bff;
    }
    #chat-input-box button {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      user-select: none;
    }
    #chat-input-box button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

<div id="chat-toggle" title="驻转 爪'"></div>

<div id="chatbot-box" aria-live="polite" role="region" aria-label="爪' ">
  <div id="chat-header">爪' 拽专住 </div>
  <div id="chat-messages" tabindex="0"></div>
  <div id="chat-input-box">
    <input type="text" id="chat-input" aria-label="砖 砖 注 拽专住" autocomplete="off" />
    <button id="send-btn" aria-label="砖 注">砖</button>
  </div>
</div>

<script>
  //  转砖 转 转转 砖专转 砖
  const API_BASE_URL = "http://localhost:3000/api/chat";

  const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbzX9DmUZ_Gekr62E9y1vLpoAaNcNbScqr0sD2dtG5X8wtGmj74r7i4kGRNdASwNBDOT/exec';

  const CONTACT_URL = "https://yuzok101.github.io/yuzukmedic/kesher.html";

  let coursesData = [];
  let knowledgeText = "";

  let chatMessages, chatInput, chatToggle, chatbotBox;

  async function loadCourses() {
    try {
      const res = await fetch(GOOGLE_SHEETS_API);
      const data = await res.json();
      if (Array.isArray(data) && data.length > 0) {
        coursesData = data;
        appendMessage("", "注 注 注 拽专住. 驻砖专 砖  专!");
      } else {
        appendMessage("", " 爪 拽专住 注专转.");
      }
    } catch (e) {
      appendMessage("", "砖 注转 注, 住 砖转 专 转专.");
      console.error(e);
    }
  }

  async function loadKnowledgeText() {
    try {
      const res = await fetch("/data/1234.txt");
      if (res.ok) {
        knowledgeText = await res.text();
        appendMessage("", "注 注 住祝 拽抓 拽住.");
      }
    } catch(e) {
      console.error("砖 注转 拽住 -1234.txt:", e);
    }
  }

  function appendMessage(sender, text) {
    const msg = document.createElement("div");
    msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function searchLocalCourses(query) {
    query = query.toLowerCase();

    for (let c of coursesData) {
      let dateStart = c['转专 转'] || "";
      let dateEnd = c['转专 住'] || "";
      let days = c[' 驻砖'] || "";
      let hours = c['砖注转'] || "";
      let price = c['专'] || "";
      let audience = c['拽 注'] || "";
      let location = c['拽'] || "";
      let notes = c['注专转'] || "";
      let training = c['砖专'] || "";

      let combinedText = [dateStart, dateEnd, days, hours, price, audience, location, notes, training].join(" ").toLowerCase();

      if (combinedText.includes(query)) {
        return `拽专住: ${training || " 爪"}\n转专 转: ${dateStart}\n转专 住: ${dateEnd}\n 驻砖: ${days}\n砖注转: ${hours}\n专: ${price}\n拽 注: ${audience}\n拽: ${location}\n注专转: ${notes}`;
      }
    }
    return null;
  }

  async function callOpenAI(question, contextText) {
    try {
      const messages = [
        {
          role: "system",
          content: "转 注专  注转 专拽 注 砖转 注 拽专住 转 注 .   , 转 ' 爪转 注专 ' 转 转 拽砖专 爪专转 拽砖专."
        },
        {
          role: "user",
          content: contextText + "\n\n砖: " + question
        }
      ];

      const response = await fetch(API_BASE_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          messages,
          max_tokens: 400,
          temperature: 0.2
        })
      });

      if (!response.ok) {
        console.error("砖 拽专 砖专转 -API:", response.status);
        return null;
      }

      const data = await response.json();

      let answer = data.choices?.[0]?.message?.content.trim();

      if (!answer || answer.toLowerCase().includes("i'm sorry") || answer.toLowerCase().includes("")) {
        return null;
      }

      return answer;

    } catch (e) {
      console.error(e);
      return null;
    }
  }

  async function sendMessage() {
    const question = chatInput.value.trim();
    if (!question) return;

    appendMessage("转", question);
    chatInput.value = "";
    chatInput.disabled = true;

    let localAnswer = searchLocalCourses(question);

    if (localAnswer) {
      appendMessage("", localAnswer);
      chatInput.disabled = false;
      chatInput.focus();
      return;
    }

    const contextTextCourses = coursesData.map(c => {
      return `拽专住: ${c['砖专'] || " 爪"} - 转专 转: ${c['转专 转'] || " 注"}, 专: ${c['专'] || " 注"}`;
    }).join("\n");

    const fullContext = contextTextCourses + "\n\n注 住祝:\n" + knowledgeText;

    let gptAnswer = await callOpenAI(question, fullContext);

    if (gptAnswer) {
      appendMessage("", gptAnswer);
    } else {
      appendMessage("", ` 爪转 注专 .  转专爪, 驻  专 注 爪专转 拽砖专:\n${CONTACT_URL}`);
    }

    chatInput.disabled = false;
    chatInput.focus();
  }

  window.onload = () => {
    chatToggle = document.getElementById("chat-toggle");
    chatbotBox = document.getElementById("chatbot-box");
    chatMessages = document.getElementById("chat-messages");
    chatInput = document.getElementById("chat-input");

    chatToggle.addEventListener("click", () => {
      if (chatbotBox.style.display === "flex") chatbotBox.style.display = "none";
      else {
        chatbotBox.style.display = "flex";
        chatInput.focus();
      }
    });

    document.getElementById("send-btn").addEventListener("click", sendMessage);

    chatInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    loadCourses();
    loadKnowledgeText();
  };
</script>

</body>
</html>
