<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>爪'  注 住 拽专住</title>
<style>
  * { box-sizing: border-box; }
  body { margin: 0; font-family: Arial, sans-serif; background: transparent; }
  #chat-toggle {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background-color: #007bff;
    color: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 30px;
    text-align: center;
    line-height: 60px;
    cursor: pointer;
    z-index: 9999;
    animation: float 2s ease-in-out infinite;
    user-select: none;
  }
  @keyframes float {
    0% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
    100% { transform: translateY(0); }
  }
  #chatbox {
    position: fixed;
    bottom: 90px;
    left: 20px;
    width: 360px;
    max-height: 520px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 10px;
    display: none;
    flex-direction: column;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 9999;
  }
  #chat-header {
    background-color: #007bff;
    color: white;
    padding: 10px;
    font-weight: bold;
    text-align: center;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    user-select: none;
  }
  #chat-messages {
    padding: 10px;
    overflow-y: auto;
    flex: 1;
    font-size: 14px;
    background: #f9f9f9;
    direction: rtl;
    word-wrap: break-word;
    white-space: pre-wrap;
  }
  .message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 15px;
    max-width: 80%;
    display: inline-block;
    clear: both;
  }
  .user {
    background-color: #d0e6ff;
    align-self: flex-end;
    float: right;
    text-align: right;
  }
  .bot {
    background-color: #e2e2e2;
    align-self: flex-start;
    float: left;
    text-align: right;
  }
  #chat-input-container {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ccc;
    gap: 6px;
  }
  #chat-input {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  #send-btn {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }
</style>
</head>
<body>

<div id="chat-toggle" title="驻转转 爪'"></div>

<div id="chatbox" role="dialog" aria-labelledby="chat-header" aria-modal="true" aria-hidden="true">
  <div id="chat-header">注抓 拽专住 </div>
  <div id="chat-messages" aria-live="polite" aria-relevant="additions"></div>
  <div id="chat-input-container">
    <input id="chat-input" type="text" placeholder="砖 转  专..." aria-label="砖转 爪'" autocomplete="off" />
    <button id="send-btn" aria-label="砖 注">砖</button>
  </div>
</div>

<script>
  const toggle = document.getElementById("chat-toggle");
  const chatbox = document.getElementById("chatbox");
  const input = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");
  const messages = document.getElementById("chat-messages");

  const apiKey = "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";
  const sheetURL = "https://script.google.com/macros/s/AKfycbzX9DmUZ_Gekr62E9y1vLpoAaNcNbScqr0sD2dtG5X8wtGmj74r7i4kGRNdASwNBDOT/exec";

  let extraText = "";
  let courseData = "";
  let chatHistory = [];

  async function loadText() {
    try {
      const res = await fetch("data/1234.txt");
      extraText = await res.text();
    } catch (e) {
      console.error("砖 注转 1234.txt:", e);
    }
  }

  async function loadCourses() {
    try {
      const res = await fetch(sheetURL);
      const data = await res.json();
      courseData = data.map(course => {
        return `砖专: ${course['砖专'] || ' 爪'}
转专 转: ${course['转专 转'] || ' 爪'}
转专 住: ${course['转专 住'] || ' 爪'}
 驻砖: ${course[' 驻砖'] || ' 爪'}
砖注转: ${course['砖注转'] || ' 爪'}
专: ${course['专'] || ' 爪'}
拽 注: ${course['拽 注'] || ' 爪'}
拽: ${course['拽'] || ' 爪'}
注专转: ${course['注专转'] || ' 注专转'}
`;
      }).join('\n\n');
    } catch (e) {
      console.error("砖 注转 拽专住:", e);
    }
  }

  function addMessage(text, sender) {
    const msg = document.createElement("div");
    msg.className = `message ${sender}`;
    msg.textContent = text;
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
  }

  async function sendMessage() {
    const userInput = input.value.trim();
    if (!userInput) return;

    addMessage(userInput, "user");
    input.value = "";

    chatHistory.push({ role: "user", content: userInput });

    const systemPrompt = `
转 注专 专  砖 砖 注 砖转砖  拽专住.
砖   注 拽专住 转 砖转: 转专 转, 转专 住,  驻砖, 砖注转, 专, 拽 注, 拽, 注专转 砖专.
注转 砖, 转 砖 转 砖转砖 砖转 专转 (:  住 拽专住  驻砖?   专  砖? 驻  专爪 ?),  驻砖 拽专住 转 转 转专 爪  转.

 砖转砖 砖 砖转 转, 注 爪专 转转 注转.

  拽专住 转, 专 " 专注 拽专住 砖转 专砖转."

砖转砖 注  注 拽专住:

${courseData}

住祝 砖 注 住祝:

${extraText}

  注, 专 住:
"爪注专,  爪转 注专 . 转 爪专 拽砖专 : https://yuzok101.github.io/yuzukmedic/kesher.html"
    `;

    const messagesForAPI = [
      { role: "system", content: systemPrompt },
      ...chatHistory
    ];

    try {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: messagesForAPI,
          max_tokens: 600,
          temperature: 0.7
        })
      });

      const data = await res.json();

      let reply = data.choices?.[0]?.message?.content || "爪注专,  爪转 . 转 住转 砖?";

      //  砖 注 砖注 住驻转  
      if (/砖注|| 砖注/i.test(userInput)) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        reply += `\n\n砖注 注砖  ${timeStr}`;
      }

      addMessage(reply, "bot");
      chatHistory.push({ role: "assistant", content: reply });
    } catch (err) {
      console.error("砖 -GPT:", err);
      addMessage("专注 砖. 住 砖 专 转专.", "bot");
    }
  }

  toggle.onclick = () => {
    if (chatbox.style.display === "flex") {
      chatbox.style.display = "none";
      chatbox.setAttribute("aria-hidden", "true");
    } else {
      chatbox.style.display = "flex";
      chatbox.setAttribute("aria-hidden", "false");
      input.focus();
    }
  };

  sendBtn.onclick = sendMessage;
  input.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
  });

  async function initialize() {
    await loadText();
    await loadCourses();
  }
  initialize();
</script>

</body>
</html>
