<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>טופס הרשמה</title>
  <style>
    /* שאר ה-CSS שלך נשאר אותו דבר */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

<div class="overlay">
  <form id="registrationForm" autocomplete="off" spellcheck="false" novalidate>
    <h2>טופס הרשמה לקורס</h2>

    <label for="name">שם מלא <span style="color:red">*</span></label>
    <input type="text" id="name" name="name" required autocomplete="name" />

    <label for="phone">טלפון <span style="color:red">*</span></label>
    <input type="tel" id="phone" name="phone" required pattern="[0-9+\-\s]{7,15}" placeholder="050-1234567" autocomplete="tel" />

    <label for="email">אימייל <span style="color:red">*</span></label>
    <input type="email" id="email" name="email" required placeholder="example@mail.com" autocomplete="email" />

    <label for="courseSelect">בחר קורס</label>
    <select id="courseSelect" name="courseSelect" style="display:none;">
      <option value="">-- בחר קורס מהרשימה --</option>
    </select>
    <input type="text" id="courseName" name="courseName" readonly style="display:none;" />

    <label for="startDate">תאריך התחלה</label>
    <input type="text" id="startDate" name="startDate" readonly />

    <label for="endDate">תאריך סיום</label>
    <input type="text" id="endDate" name="endDate" readonly />

    <label for="location">מיקום</label>
    <input type="text" id="location" name="location" readonly />

    <label for="paymentMethod">אופן תשלום</label>
    <select id="paymentMethod" name="paymentMethod" required>
      <option value="" disabled selected>בחר אופן תשלום</option>
      <option value="אשראי">אשראי</option>
      <option value="מזומן">מזומן</option>
      <option value="העברה בנקאית">העברה בנקאית</option>
      <option value="ביט">ביט</option>
    </select>

    <label for="notes">הערות</label>
    <textarea id="notes" name="notes" rows="4" placeholder="הקלד הערות אם יש..."></textarea>

    <button type="submit" id="submitBtn">
      <span class="btn-text">שלח טופס הרשמה</span>
      <svg class="plane-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    </button>
    <div class="thankyou-message" id="thankyouMessage">
      השליחה הצליחה, ניצור איתך קשר בהקדם.
    </div>
    <div class="error-message" id="errorMessage">
      <!-- הודעת שגיאה תופיע כאן -->
    </div>
  </form>
</div>

<script>
  emailjs.init("miOp6iToFLfbH1jk5");

  function getQueryParams() {
    const params = {};
    const query = window.location.search.substring(1);
    query.split("&").forEach(pair => {
      const [key, value] = pair.split("=");
      if (key) params[decodeURIComponent(key)] = decodeURIComponent(value || "");
    });
    return params;
  }

  function clearCourseFields() {
    document.getElementById('courseName').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('location').value = '';
  }

  function fillCourseFields(courseObj) {
    document.getElementById('courseName').value = courseObj.type || '';
    document.getElementById('startDate').value = courseObj.startDate || '';
    document.getElementById('endDate').value = courseObj.endDate || '';
    document.getElementById('location').value = courseObj.location || '';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const params = getQueryParams();
    const courseSelect = document.getElementById('courseSelect');
    const courseNameInput = document.getElementById('courseName');

    // אם יש פרמטרים מלאים בקישור, מגדירים ומסתירים תפריט בחירה
    if (params.type && params.startDate && params.endDate && params.location) {
      fillCourseFields({
        type: params.type,
        startDate: params.startDate,
        endDate: params.endDate,
        location: params.location
      });
      courseNameInput.style.display = 'block';
      courseSelect.style.display = 'none';
    } else {
      // אין פרמטרים, נטען רשימת קורסים מה-API ונציג את התפריט
      courseNameInput.style.display = 'none';
      courseSelect.style.display = 'block';

      fetch('https://script.google.com/macros/s/AKfycbzX9DmUZ_Gekr62E9y1vLpoAaNcNbScqr0sD2dtG5X8wtGmj74r7i4kGRNdASwNBDOT/exec')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          // מניח שהנתונים במבנה: data = [{type:..., startDate:..., endDate:..., location:...}, ...]
          if (!Array.isArray(data) || data.length === 0) {
            courseSelect.innerHTML = '<option value="">לא נמצאו קורסים זמינים</option>';
            return;
          }
          // ניצור אפשרויות
          courseSelect.innerHTML = '<option value="">-- בחר קורס מהרשימה --</option>';
          data.forEach(course => {
            // נשמור את כל פרטי הקורס בתוך value כ-JSON
            const val = JSON.stringify(course);
            // נציג בטקסט את סוג הקורס, תאריכים ומיקום
            const text = `${course.type} | ${course.startDate} - ${course.endDate} | ${course.location}`;
            const option = document.createElement('option');
            option.value = val;
            option.textContent = text;
            courseSelect.appendChild(option);
          });

          // כדי לוודא שבבחירה הראשונה מתמלאים השדות, נמלא את השדות אם כבר נבחר משהו
          if (courseSelect.value) {
            const selectedCourse = JSON.parse(courseSelect.value);
            fillCourseFields(selectedCourse);
          }
        })
        .catch(error => {
          console.error('שגיאה בטעינת הקורסים:', error);
          courseSelect.innerHTML = '<option value="">שגיאה בטעינת הקורסים</option>';
        });

      // מאזין לשינוי בבחירת הקורס
      courseSelect.addEventListener('change', () => {
        if (!courseSelect.value) {
          clearCourseFields();
          return;
        }
        try {
          const selectedCourse = JSON.parse(courseSelect.value);
          fillCourseFields(selectedCourse);
        } catch (e) {
          clearCourseFields();
          console.error('שגיאה בפרשנות הקורס שנבחר:', e);
        }
      });
    }

    // שאר הקוד לטיפול בטופס ושליחה דרך emailjs
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const thankyouMsg = document.getElementById('thankyouMessage');
    const errorMsg = document.getElementById('errorMessage');
    const btnText = submitBtn.querySelector('.btn-text');
    const planeIcon = submitBtn.querySelector('.plane-icon');

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      errorMsg.style.display = 'none';
      thankyouMsg.style.display = 'none';

      submitBtn.disabled = true;
      btnText.textContent = "שולח את הטופס שלך...";
      planeIcon.style.display = 'inline-block';
      planeIcon.style.animation = 'none';
      // פעולה לאתחול האנימציה מחדש
      planeIcon.offsetHeight; 
      planeIcon.style.animation = null;

      const data = {
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        email: form.email.value.trim(),
        course: form.courseName.value || (() => {
          const sel = document.getElementById('courseSelect');
          return sel.options[sel.selectedIndex] ? JSON.parse(sel.value).type : '';
        })(),
        startDate: form.startDate.value,
        endDate: form.endDate.value,
        location: form.location.value,
        paymentMethod: form.paymentMethod.value,
        notes: form.notes.value.trim()
      };

      emailjs.send("service_45f1wyc", "template_18zogtj", data)
        .then(() => {
          submitBtn.disabled = false;
          planeIcon.style.display = 'none';
          btnText.textContent = "שלח הרשמה";
          thankyouMsg.style.display = 'block';
          errorMsg.style.display = 'none';
        })
        .catch((error) => {
          submitBtn.disabled = false;
          planeIcon.style.display = 'none';
          btnText.textContent = "שלח הרשמה";
          errorMsg.textContent = "אירעה שגיאה בשליחה. נסה שוב.";
          errorMsg.style.display = 'block';
          thankyouMsg.style.display = 'none';
          console.error('שגיאה בשליחת המייל דרך EmailJS:', error);
        });
    });
  });
</script>

<!-- שאר הסקריפטים שלך נשארים כפי שהם -->

</body>
</html>
