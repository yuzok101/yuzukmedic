<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>טופס הרשמה</title>
<style>
  /* ... השארתי כאן את העיצוב המלא שלך כפי שביקשת, כולל אנימציות ועוד ... */
</style>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

<div class="overlay">
  <form id="registrationForm" autocomplete="off" spellcheck="false" novalidate>
    <h2>טופס הרשמה לקורס</h2>

    <!-- כל שאר השדות שלך כמות שהם -->
    <label for="courseSelect">שם הקורס</label>
    <select id="courseSelect" name="courseSelect" style="display:none;"></select>
    <input type="text" id="courseName" name="courseName" readonly />

    <label for="startDate">תאריך התחלה</label>
    <input type="text" id="startDate" name="startDate" readonly />

    <label for="endDate">תאריך סיום</label>
    <input type="text" id="endDate" name="endDate" readonly />

    <label for="location">מיקום</label>
    <input type="text" id="location" name="location" readonly />

    <!-- שאר שדות כגון name, phone, email, paymentMethod, notes -->
    <button type="submit" id="submitBtn">
      <span class="btn-text">שלח טופס הרשמה</span>
      <svg class="plane-icon" ...></svg>
    </button>
    <div class="thankyou-message" id="thankyouMessage">השליחה הצליחה, ניצור איתך קשר בהקדם.</div>
    <div class="error-message" id="errorMessage"></div>
  </form>
</div>

<script>
  emailjs.init("miOp6iToFLfbH1jk5");  // השארתי כמו שיש לך

  const SHEET_URL = 'https://script.google.com/macros/s/AKfycbzX9DmUZ_Gekr62E9y1vLpoAaNcNbScqr0sD2dtG5X8wtGmj74r7i4kGRNdASwNBDOT/exec';

  function getQueryParams() {
    const p = {};
    window.location.search.substring(1).split("&").forEach(pair => {
      const [k,v] = pair.split("=");
      if (k) p[decodeURIComponent(k)] = decodeURIComponent(v||"");
    });
    return p;
  }

  function parseDate(str) {
    const [d,m,y] = str.split('.');
    return new Date(`${y}-${m}-${d}`);
  }

  async function loadCoursesToSelect() {
    try {
      const res = await fetch(SHEET_URL);
      const courses = await res.json();
      const now = new Date();
      const sel = document.getElementById('courseSelect');

      courses.filter(c => parseDate(c.startDate) >= now)
             .forEach(c => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(c);
        opt.textContent = `${c.type} | ${c.startDate} - ${c.endDate} | ${c.location}`;
        sel.appendChild(opt);
      });

      sel.style.display = 'block';
      sel.addEventListener('change', e => {
        const c = JSON.parse(e.target.value);
        document.getElementById('courseName').value = c.type;
        document.getElementById('startDate').value = c.startDate;
        document.getElementById('endDate').value = c.endDate;
        document.getElementById('location').value = c.location;
      });
    } catch (err) {
      console.error('שגיאה בטעינת קורסים:', err);
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const params = getQueryParams();

    if (params.type && params.startDate && params.endDate && params.location) {
      // מילוי אוטומטי מהקישור
      document.getElementById('courseName').value = params.type;
      document.getElementById('startDate').value = params.startDate;
      document.getElementById('endDate').value = params.endDate;
      document.getElementById('location').value = params.location;
      document.getElementById('courseName').style.display = 'block';
      document.getElementById('courseSelect').style.display = 'none';
    } else {
      // אין פרמטרים – טען קורסים לקריאה
      document.getElementById('courseName').style.display = 'none';
      await loadCoursesToSelect();
    }

    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const thankMsg = document.getElementById('thankyouMessage');
    const errMsg = document.getElementById('errorMessage');
    const btnText = submitBtn.querySelector('.btn-text');
    const planeIcon = submitBtn.querySelector('.plane-icon');

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      errMsg.style.display = 'none';
      thankMsg.style.display = 'none';

      submitBtn.disabled = true;
      btnText.textContent = "שולח את הטופס שלך...";
      planeIcon.style.display = 'inline-block';
      planeIcon.offsetHeight;
      planeIcon.style.animation = null;

      const data = {
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        email: form.email.value.trim(),
        course: form.courseName.value,
        startDate: form.startDate.value,
        endDate: form.endDate.value,
        location: form.location.value,
        paymentMethod: form.paymentMethod.value,
        notes: form.notes.value.trim()
      };

      emailjs.send("service_45f1wyc", "template_18zogtj", data)
        .then(() => {
          submitBtn.disabled = false;
          planeIcon.style.display = 'none';
          btnText.textContent = "שלח טופס הרשמה";
          thankMsg.style.display = 'block';
        })
        .catch(error => {
          submitBtn.disabled = false;
          planeIcon.style.display = 'none';
          btnText.textContent = "שלח טופס הרשמה";
          errMsg.textContent = "אירעה שגיאה בשליחה. נסה שוב.";
          errMsg.style.display = 'block';
          console.error('שגיאה ב־EmailJS:', error);
        });
    });
  });
</script>

<!-- Nagishli שלך נשאר כמו שהיה -->
<script>nl_pos = "bl"; /* ... */</script>
<script src="https://yuzok101.github.io/yuzukmedic/data/nagishli.js" defer></script>

</body>
</html>
