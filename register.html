<script>
emailjs.init("miOp6iToFLfbH1jk5");

function getQueryParams() {
  const params = {};
  const query = window.location.search.substring(1);
  query.split("&").forEach(pair => {
    const [key, value] = pair.split("=");
    if (key) params[decodeURIComponent(key)] = decodeURIComponent(value || "");
  });
  return params;
}

function clearCourseFields() {
  document.getElementById('courseName').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('location').value = '';
}

function fillCourseFields(courseObj) {
  document.getElementById('courseName').value = courseObj.type || '';
  document.getElementById('startDate').value = courseObj.startDate || '';
  document.getElementById('endDate').value = courseObj.endDate || '';
  document.getElementById('location').value = courseObj.location || '';
}

document.addEventListener('DOMContentLoaded', () => {
  const params = getQueryParams();
  const courseSelect = document.getElementById('courseSelect');
  const courseNameInput = document.getElementById('courseName');

  if (params.type && params.startDate && params.endDate && params.location) {
    fillCourseFields(params);
    courseNameInput.style.display = 'block';
    courseSelect.style.display = 'none';
  } else {
    courseNameInput.style.display = 'none';
    courseSelect.style.display = 'block';

    fetch('https://script.google.com/macros/s/AKfycbw13Ym4c0MLFGruTaq7WT08qoAqytQ5E66J6NiAs-H9muwnjkb1cvF2EgRUfdL2sr6UGQ/exec')
      .then(res => res.json())
      .then(data => {
        courseSelect.innerHTML = '<option value="">-- בחר קורס מהרשימה --</option>';
        data.forEach(course => {
          const opt = document.createElement('option');
          opt.value = JSON.stringify(course);
          opt.textContent = `${course.type} | ${course.startDate} - ${course.endDate} | ${course.location}`;
          courseSelect.appendChild(opt);
        });
      })
      .catch(() => {
        courseSelect.innerHTML = '<option value="">שגיאה בטעינת הקורסים</option>';
      });

    courseSelect.addEventListener('change', () => {
      try {
        const selectedCourse = JSON.parse(courseSelect.value);
        fillCourseFields(selectedCourse);
      } catch {
        clearCourseFields();
      }
    });
  }

  const form = document.getElementById('registrationForm');
  const submitBtn = document.getElementById('submitBtn');
  const thankyouMsg = document.getElementById('thankyouMessage');
  const errorMsg = document.getElementById('errorMessage');
  const btnText = submitBtn.querySelector('.btn-text');
  const planeIcon = submitBtn.querySelector('.plane-icon');

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    errorMsg.style.display = 'none';
    thankyouMsg.style.display = 'none';

    submitBtn.disabled = true;
    btnText.textContent = "שולח את הטופס שלך...";
    planeIcon.style.display = 'inline-block';
    planeIcon.style.animation = 'none';
    planeIcon.offsetHeight;
    planeIcon.style.animation = null;

    const data = {
      name: form.name.value.trim(),
      phone: form.phone.value.trim(),
      email: form.email.value.trim(),
      course: form.courseName.value || (() => {
        const sel = document.getElementById('courseSelect');
        return sel.options[sel.selectedIndex] ? JSON.parse(sel.value).type : '';
      })(),
      startDate: form.startDate.value,
      endDate: form.endDate.value,
      location: form.location.value,
      paymentMethod: "אשראי",
      notes: form.notes.value.trim()
    };

    if (!data.email || !data.phone || !data.course) {
      submitBtn.disabled = false;
      planeIcon.style.display = 'none';
      btnText.textContent = "שלח הרשמה";
      errorMsg.textContent = "אנא מלא את כל השדות החובה: מייל, טלפון וקורס.";
      errorMsg.style.display = 'block';
      return;
    }

    // שליחה ל־EmailJS
    emailjs.send("service_45f1wyc", "template_18zogtj", data)
      .then(() => {
        // שליחה ל־Google Sheets
        return fetch("https://script.google.com/macros/s/AKfycbw13Ym4c0MLFGruTaq7WT08qoAqytQ5E66J6NiAs-H9muwnjkb1cvF2EgRUfdL2sr6UGQ/exec", {
          method: "POST",
          body: JSON.stringify(data)
        });
      })
      .then(() => {
        // הפניה ליש חשבונית עם URL להחזרה אחרי התשלום
        const successUrl = "https://yuzok101.github.io/yuzukmedic/1";
        const basePayUrl = "https://user.yeshinvoice.co.il/payment/7fa9075d-1b2a-43aa-8078-173c2ae9eb2c";
        const payUrl = `${basePayUrl}?name=${encodeURIComponent(data.name)}&numberid=${encodeURIComponent("")}&address=${encodeURIComponent("")}&city=${encodeURIComponent("")}&phone=${encodeURIComponent(data.phone)}&mobile=${encodeURIComponent(data.phone)}&email=${encodeURIComponent(data.email)}&price=${encodeURIComponent("")}&return_url=${encodeURIComponent(successUrl)}`;

        // הפנייה לדף התשלום
        window.location.href = payUrl;
      })
      .catch(() => {
        submitBtn.disabled = false;
        planeIcon.style.display = 'none';
        btnText.textContent = "שלח הרשמה";
        errorMsg.textContent = "אירעה שגיאה בשליחה. נסה שוב.";
        errorMsg.style.display = 'block';
      });
  });
});
</script>
