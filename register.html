<script>
  emailjs.init("miOp6iToFLfbH1jk5");

  function getQueryParams() {
    const params = {};
    const query = window.location.search.substring(1);
    query.split("&").forEach(pair => {
      const [key, value] = pair.split("=");
      if (key) params[decodeURIComponent(key)] = decodeURIComponent(value || "");
    });
    return params;
  }

  function clearCourseFields() {
    document.getElementById('courseName').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('location').value = '';
  }

  function fillCourseFields(courseObj) {
    document.getElementById('courseName').value = courseObj.type || '';
    document.getElementById('startDate').value = courseObj.startDate || '';
    document.getElementById('endDate').value = courseObj.endDate || '';
    document.getElementById('location').value = courseObj.location || '';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const params = getQueryParams();
    const courseSelect = document.getElementById('courseSelect');
    const courseNameInput = document.getElementById('courseName');

    if (params.type && params.startDate && params.endDate && params.location) {
      fillCourseFields({
        type: params.type,
        startDate: params.startDate,
        endDate: params.endDate,
        location: params.location
      });
      courseNameInput.style.display = 'block';
      courseSelect.style.display = 'none';
    } else {
      courseNameInput.style.display = 'none';
      courseSelect.style.display = 'block';

      fetch('https://script.google.com/macros/s/AKfycbzX9DmUZ_Gekr62E9y1vLpoAaNcNbScqr0sD2dtG5X8wtGmj74r7i4kGRNdASwNBDOT/exec')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            courseSelect.innerHTML = '<option value="">לא נמצאו קורסים זמינים</option>';
            return;
          }
          courseSelect.innerHTML = '<option value="">-- בחר קורס מהרשימה --</option>';
          data.forEach(course => {
            const val = JSON.stringify(course);
            const text = `${course.type} | ${course.startDate} - ${course.endDate} | ${course.location}`;
            const option = document.createElement('option');
            option.value = val;
            option.textContent = text;
            courseSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error('שגיאה בטעינת הקורסים:', error);
          courseSelect.innerHTML = '<option value="">שגיאה בטעינת הקורסים</option>';
        });

      courseSelect.addEventListener('change', () => {
        if (!courseSelect.value) {
          clearCourseFields();
          return;
        }
        try {
          const selectedCourse = JSON.parse(courseSelect.value);
          fillCourseFields(selectedCourse);
        } catch (e) {
          clearCourseFields();
          console.error('שגיאה בפרשנות הקורס שנבחר:', e);
        }
      });
    }

    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const thankyouMsg = document.getElementById('thankyouMessage');
    const errorMsg = document.getElementById('errorMessage');
    const btnText = submitBtn.querySelector('.btn-text');
    const planeIcon = submitBtn.querySelector('.plane-icon');

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      errorMsg.style.display = 'none';
      thankyouMsg.style.display = 'none';

      submitBtn.disabled = true;
      btnText.textContent = "שולח את הטופס שלך...";
      planeIcon.style.display = 'inline-block';
      planeIcon.style.animation = 'none';
      planeIcon.offsetHeight;
      planeIcon.style.animation = null;

      const data = {
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        email: form.email.value.trim(),
        course: form.courseName.value || (() => {
          const sel = document.getElementById('courseSelect');
          return sel.options[sel.selectedIndex] ? JSON.parse(sel.value).type : '';
        })(),
        startDate: form.startDate.value,
        endDate: form.endDate.value,
        location: form.location.value,
        paymentMethod: form.paymentMethod.value,
        notes: form.notes.value.trim()
      };

      // ✦ ולידציה לשדות חובה ✦
      if (!data.email || !data.phone || !data.course) {
        submitBtn.disabled = false;
        planeIcon.style.display = 'none';
        btnText.textContent = "שלח הרשמה";
        errorMsg.textContent = "אנא מלא את כל השדות החובה: מייל, טלפון וקורס.";
        errorMsg.style.display = 'block';
        thankyouMsg.style.display = 'none';
        return;
      }

      emailjs.send("service_45f1wyc", "template_18zogtj", data)
        .then(() => {
          submitBtn.disabled = false;
          planeIcon.style.display = 'none';
          btnText.textContent = "שלח הרשמה";
          thankyouMsg.style.display = 'block';
          errorMsg.style.display = 'none';
        })
        .catch((error) => {
          submitBtn.disabled = false;
          planeIcon.style.display = 'none';
          btnText.textContent = "שלח הרשמה";
          errorMsg.textContent = "אירעה שגיאה בשליחה. נסה שוב.";
          errorMsg.style.display = 'block';
          thankyouMsg.style.display = 'none';
          console.error('שגיאה בשליחת המייל דרך EmailJS:', error);
        });
    });
  });
</script>
